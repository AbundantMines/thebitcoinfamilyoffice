<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard — Bitcoin Estate Watch</title>
<meta name="robots" content="noindex,nofollow">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=EB+Garamond:wght@400;500&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<script>(function(){var g=window.dataLayer=window.dataLayer||[];function gtag(){g.push(arguments);}gtag('js',new Date());gtag('config','G-N8PP20VBTV');})();</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-N8PP20VBTV"></script>
<style>
:root{--bg:#0a0a0a;--bg-elevated:#111111;--bg-card:#141414;--border:#1e1e1e;--text:#e8e0d0;--text-secondary:#8a8070;--accent:#c9a84c;--accent-border:rgba(201,168,76,0.2);--display:'Playfair Display',Georgia,serif;--sans:'Inter',system-ui,sans-serif;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;}
/* NAV */
nav{display:flex;align-items:center;justify-content:space-between;padding:1.1rem 2rem;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg);z-index:100;}
.nav-logo{font-size:.72rem;letter-spacing:.15em;text-transform:uppercase;color:var(--accent);}
.nav-right{display:flex;align-items:center;gap:1.5rem;}
.nav-right a{font-size:.72rem;letter-spacing:.08em;text-transform:uppercase;color:var(--text-secondary);text-decoration:none;}
.nav-right a:hover{color:var(--accent);}
.nav-tier{font-size:.65rem;letter-spacing:.1em;text-transform:uppercase;background:rgba(201,168,76,.1);color:var(--accent);border:1px solid var(--accent-border);padding:.25rem .7rem;border-radius:2px;}
/* MAIN */
.main{max-width:1100px;margin:0 auto;padding:2.5rem 2rem;}
.greeting{margin-bottom:2.5rem;}
.greeting h1{font-family:var(--display);font-size:2.2rem;font-weight:400;color:var(--text);}
.greeting p{font-size:.85rem;color:var(--text-secondary);margin-top:.3rem;}
/* STAT CARDS */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:2rem;}
.stat-card{background:var(--bg-elevated);border:1px solid var(--border);border-radius:3px;padding:1.5rem;}
.stat-label{font-size:.68rem;letter-spacing:.1em;text-transform:uppercase;color:var(--text-secondary);margin-bottom:.6rem;}
.stat-val{font-size:1.6rem;color:var(--text);font-weight:300;line-height:1;}
.stat-val.accent{color:var(--accent);}
.stat-sub{font-size:.72rem;color:var(--text-secondary);margin-top:.4rem;}
/* SECTIONS */
.section{background:var(--bg-elevated);border:1px solid var(--border);border-radius:3px;padding:1.75rem;margin-bottom:1.5rem;}
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;}
.section-title{font-size:.75rem;letter-spacing:.12em;text-transform:uppercase;color:var(--text-secondary);}
.section-action{font-size:.72rem;color:var(--accent);text-decoration:none;letter-spacing:.05em;}
/* CHART placeholder */
.chart-area{height:160px;background:var(--bg-card);border:1px solid var(--border);border-radius:2px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;}
.chart-line{position:absolute;bottom:0;left:0;right:0;height:60%;}
.chart-note{font-size:.75rem;color:var(--text-secondary);z-index:1;}
/* ALERT TABLE */
table{width:100%;border-collapse:collapse;}
th{font-size:.65rem;letter-spacing:.1em;text-transform:uppercase;color:var(--text-secondary);padding:.5rem .75rem;text-align:left;border-bottom:1px solid var(--border);}
td{font-size:.82rem;color:var(--text);padding:.75rem .75rem;border-bottom:1px solid var(--border);}
tr:last-child td{border-bottom:none;}
td.muted{color:var(--text-secondary);}
td.up{color:#e87070;}
td.down{color:#70c87a;}
/* SCORECARD (Pro) */
.score-wrap{display:flex;align-items:center;gap:2.5rem;margin-bottom:1.5rem;}
.score-circle-wrap{flex-shrink:0;}
.score-meta h3{font-family:var(--display);font-size:1.4rem;color:var(--text);margin-bottom:.3rem;}
.score-meta p{font-size:.8rem;color:var(--text-secondary);line-height:1.6;}
.score-btn{display:inline-block;margin-top:.75rem;font-size:.72rem;letter-spacing:.1em;text-transform:uppercase;color:var(--accent);border:1px solid var(--accent-border);padding:.5rem 1.2rem;border-radius:2px;text-decoration:none;}
/* SETTINGS */
.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.25rem;}
.form-group{display:flex;flex-direction:column;gap:.4rem;}
.form-group label{font-size:.68rem;letter-spacing:.1em;text-transform:uppercase;color:var(--text-secondary);}
.form-group input,.form-group select{background:var(--bg);border:1px solid var(--border);border-radius:2px;padding:.7rem .9rem;color:var(--text);font-family:var(--sans);font-size:.88rem;outline:none;}
.form-group input:focus,.form-group select:focus{border-color:var(--accent);}
.save-btn{background:var(--accent);color:#0a0a0a;border:none;border-radius:2px;padding:.7rem 1.75rem;font-size:.72rem;letter-spacing:.1em;text-transform:uppercase;font-weight:600;cursor:pointer;margin-top:.5rem;}
/* PRO GATE */
.pro-gate{background:var(--bg-card);border:1px solid var(--accent-border);border-radius:3px;padding:2rem;text-align:center;}
.pro-gate h3{font-family:var(--display);font-size:1.3rem;color:var(--text);margin-bottom:.6rem;}
.pro-gate p{font-size:.82rem;color:var(--text-secondary);line-height:1.7;margin-bottom:1.25rem;}
.upgrade-btn{display:inline-block;background:var(--accent);color:#0a0a0a;padding:.75rem 2rem;border-radius:2px;font-size:.72rem;letter-spacing:.1em;text-transform:uppercase;font-weight:600;text-decoration:none;}
/* LOADING */
.loading{display:flex;align-items:center;justify-content:center;height:200px;color:var(--text-secondary);font-size:.85rem;}
/* AI Q&A */
.qa-wrap{display:flex;flex-direction:column;gap:1rem;}
.qa-history{max-height:300px;overflow-y:auto;display:flex;flex-direction:column;gap:.75rem;}
.qa-msg{padding:.875rem 1rem;border-radius:3px;font-size:.85rem;line-height:1.7;}
.qa-msg.user{background:var(--bg-card);border:1px solid var(--border);color:var(--text-secondary);}
.qa-msg.assistant{background:rgba(201,168,76,.05);border:1px solid var(--accent-border);color:var(--text);}
.qa-input-row{display:flex;gap:.75rem;}
.qa-input{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:2px;padding:.75rem 1rem;color:var(--text);font-family:var(--sans);font-size:.88rem;outline:none;}
.qa-input:focus{border-color:var(--accent);}
.qa-send{background:var(--accent);color:#0a0a0a;border:none;border-radius:2px;padding:.75rem 1.5rem;font-size:.72rem;letter-spacing:.1em;text-transform:uppercase;font-weight:600;cursor:pointer;}
.qa-disclaimer{font-size:.68rem;color:var(--text-secondary);line-height:1.5;}
@media(max-width:900px){.stats{grid-template-columns:1fr 1fr;} .settings-grid{grid-template-columns:1fr;}}
@media(max-width:600px){.stats{grid-template-columns:1fr;}}
</style>
</head>
<body>
<nav>
  <div class="nav-logo">Bitcoin Estate Watch</div>
  <div class="nav-right">
    <span class="nav-tier" id="tierBadge">Watch</span>
    <a href="/monitor/scorecard" id="scorecardLink">Scorecard</a>
    <a href="/monitor/heir-briefing" id="briefingLink">Heir Briefing</a>
    <a href="#settings">Settings</a>
    <a href="#" id="signOutBtn">Sign Out</a>
  </div>
</nav>
<div class="main">
  <div id="loadingState" class="loading">Loading your dashboard…</div>
  <div id="dashContent" style="display:none">
    <div class="greeting">
      <h1 id="greetingText">Good morning.</h1>
      <p id="greetingDate"></p>
    </div>
    <!-- STATS -->
    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">BTC Price</div>
        <div class="stat-val" id="statBtcPrice">—</div>
        <div class="stat-sub">Live from CoinGecko</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Estimated Estate</div>
        <div class="stat-val" id="statEstate">—</div>
        <div class="stat-sub" id="statBtcHeld">— BTC + other assets</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Est. Tax Exposure</div>
        <div class="stat-val accent" id="statTax">—</div>
        <div class="stat-sub" id="statState">Federal + state</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Days Monitored</div>
        <div class="stat-val" id="statDays">—</div>
        <div class="stat-sub">Since activation</div>
      </div>
    </div>
    <!-- TREND CHART -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">30-Day Exposure Trend</div>
      </div>
      <div class="chart-area">
        <svg class="chart-line" viewBox="0 0 400 100" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
          <defs><linearGradient id="lineGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#c9a84c" stop-opacity=".3"/><stop offset="100%" stop-color="#c9a84c" stop-opacity="0"/></linearGradient></defs>
          <path id="chartPath" d="M0,70 C40,65 80,55 120,60 C160,65 200,45 240,50 C280,55 320,40 360,35 L400,30 L400,100 L0,100 Z" fill="url(#lineGrad)"/>
          <path id="chartLine" d="M0,70 C40,65 80,55 120,60 C160,65 200,45 240,50 C280,55 320,40 360,35 L400,30" fill="none" stroke="#c9a84c" stroke-width="1.5"/>
        </svg>
        <span class="chart-note">Historical trend — populates after 30 days of monitoring</span>
      </div>
    </div>
    <!-- ALERT HISTORY -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">Alert History</div>
      </div>
      <table>
        <thead><tr><th>Date</th><th>BTC Price</th><th>Est. Estate</th><th>Est. Tax Exposure</th><th>Change</th></tr></thead>
        <tbody id="alertTableBody">
          <tr><td colspan="5" class="muted" style="text-align:center;padding:1.5rem;">Alerts will appear here when your exposure crosses your threshold.</td></tr>
        </tbody>
      </table>
    </div>
    <!-- SUCCESSION SCORECARD -->
    <div class="section" id="scorecardSection">
      <div class="section-header">
        <div class="section-title">Succession Scorecard</div>
        <a href="/monitor/scorecard" class="section-action">Open full scorecard →</a>
      </div>
      <div id="scorecardPro">
        <div class="score-wrap">
          <div class="score-circle-wrap">
            <svg width="100" height="100" viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="42" fill="none" stroke="#1e1e1e" stroke-width="8"/>
              <circle id="scoreCircle" cx="50" cy="50" r="42" fill="none" stroke="#c9a84c" stroke-width="8" stroke-dasharray="264" stroke-dashoffset="264" stroke-linecap="round" transform="rotate(-90 50 50)" style="transition:stroke-dashoffset .6s ease"/>
              <text x="50" y="46" text-anchor="middle" fill="#e8e0d0" font-family="Inter,sans-serif" font-size="18" font-weight="300" id="scoreText">0</text>
              <text x="50" y="60" text-anchor="middle" fill="#8a8070" font-family="Inter,sans-serif" font-size="9">/100</text>
            </svg>
          </div>
          <div class="score-meta">
            <h3 id="scorecardStatus">Check your heir readiness</h3>
            <p>20 items across legal documents, Bitcoin access, estate structure, and heir education. Takes 5 minutes.</p>
            <a href="/monitor/scorecard" class="score-btn">Take the Scorecard →</a>
          </div>
        </div>
      </div>
      <div id="scorecardGate" style="display:none">
        <div class="pro-gate">
          <h3>Succession Scorecard</h3>
          <p>The 20-item heir readiness assessment is a Watch Pro feature. Upgrade to access the scorecard, heir briefing generator, and daily BTC brief.</p>
          <a href="/monitor/signup?upgrade=1" class="upgrade-btn">Upgrade to Pro — $49/mo →</a>
        </div>
      </div>
    </div>
    <!-- AI Q&A (Pro) -->
    <div class="section" id="qaSection">
      <div class="section-header">
        <div class="section-title">AI Estate Planning Q&amp;A</div>
        <span style="font-size:.65rem;color:var(--text-secondary);letter-spacing:.05em;">Educational only — not legal advice</span>
      </div>
      <div id="qaPro">
        <div class="qa-wrap">
          <div class="qa-history" id="qaHistory"></div>
          <div class="qa-input-row">
            <input type="text" class="qa-input" id="qaInput" placeholder="Ask about your estate planning situation…">
            <button class="qa-send" id="qaSend" onclick="sendQuestion()">Ask →</button>
          </div>
          <p class="qa-disclaimer">Educational information only. Consult a qualified estate attorney for advice specific to your situation. Limit: 10 questions/day.</p>
        </div>
      </div>
      <div id="qaGate" style="display:none">
        <div class="pro-gate">
          <h3>AI Estate Planning Q&amp;A</h3>
          <p>Ask about your specific situation — estate structures, state tax, custody strategy. Available to Watch Pro subscribers.</p>
          <a href="/monitor/signup?upgrade=1" class="upgrade-btn">Upgrade to Pro →</a>
        </div>
      </div>
    </div>
    <!-- SETTINGS -->
    <div class="section" id="settings">
      <div class="section-header"><div class="section-title">Account Settings</div></div>
      <div class="settings-grid">
        <div class="form-group"><label>Full name</label><input type="text" id="settingName"></div>
        <div class="form-group"><label>Email</label><input type="email" id="settingEmail" disabled style="opacity:.5"></div>
        <div class="form-group"><label>Bitcoin holdings (BTC)</label><input type="number" id="settingBtc" step="0.001" min="0"></div>
        <div class="form-group"><label>Other assets (USD)</label><input type="number" id="settingOther" step="1000" min="0"></div>
        <div class="form-group">
          <label>State of residence</label>
          <select id="settingState">
            <option value="">Select…</option>
            <option>AL</option><option>AK</option><option>AZ</option><option>AR</option><option>CA</option>
            <option>CO</option><option>CT</option><option>DE</option><option>FL</option><option>GA</option>
            <option>HI</option><option>ID</option><option>IL</option><option>IN</option><option>IA</option>
            <option>KS</option><option>KY</option><option>LA</option><option>ME</option><option>MD</option>
            <option>MA</option><option>MI</option><option>MN</option><option>MS</option><option>MO</option>
            <option>MT</option><option>NE</option><option>NV</option><option>NH</option><option>NJ</option>
            <option>NM</option><option>NY</option><option>NC</option><option>ND</option><option>OH</option>
            <option>OK</option><option>OR</option><option>PA</option><option>RI</option><option>SC</option>
            <option>SD</option><option>TN</option><option>TX</option><option>UT</option><option>VT</option>
            <option>VA</option><option>WA</option><option>WV</option><option>WI</option><option>WY</option>
          </select>
        </div>
        <div class="form-group"><label>Alert threshold (%)</label><input type="number" id="settingThreshold" min="1" max="50" step="1" value="10"><span style="font-size:.7rem;color:var(--text-secondary);margin-top:.3rem;">Alert when exposure changes by this %</span></div>
      </div>
      <button class="save-btn" onclick="saveSettings()">Save Settings</button>
      <span id="saveStatus" style="margin-left:1rem;font-size:.75rem;color:var(--accent);display:none;">Saved ✓</span>
    </div>
  </div><!-- end dashContent -->
</div>
<script>
const fmt=(n)=>new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(n);
const fmtBtc=(n)=>Number(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:4});
let userData=null;
let qaHistory=[];

async function loadDashboard(){
  try{
    const r=await fetch('/api/dashboard',{credentials:'include'});
    if(r.status===401){window.location.href='/monitor/login';return;}
    const d=await r.json();
    userData=d;
    renderDashboard(d);
  }catch(ex){
    document.getElementById('loadingState').textContent='Error loading dashboard. '+ex.message;
  }
}

function renderDashboard(d){
  document.getElementById('loadingState').style.display='none';
  document.getElementById('dashContent').style.display='block';
  const hour=new Date().getHours();
  const greeting=hour<12?'Good morning':'hour<17?'Good afternoon':'Good evening';
  document.getElementById('greetingText').textContent=greeting+(d.user.name?', '+d.user.name.split(' ')[0]:'.')+'.';
  document.getElementById('greetingDate').textContent=new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
  document.getElementById('statBtcPrice').textContent=fmt(d.btcPrice||95000);
  document.getElementById('statEstate').textContent=fmt(d.exposure.totalEstate);
  document.getElementById('statBtcHeld').textContent=fmtBtc(d.user.btcAmount)+' BTC + assets';
  document.getElementById('statTax').textContent=d.exposure.totalTax>0?fmt(d.exposure.totalTax):'$0 (below threshold)';
  document.getElementById('statState').textContent=d.exposure.hasStateTax?'Federal + '+d.user.state+' state tax':'Federal only ('+d.user.state+' no state tax)';
  const created=new Date(d.user.createdAt||Date.now());
  const days=Math.max(0,Math.round((Date.now()-created.getTime())/86400000));
  document.getElementById('statDays').textContent=days;
  document.getElementById('tierBadge').textContent=d.user.tier==='pro'?'Watch Pro':'Watch';
  // Scorecard score from localStorage
  const score=parseInt(localStorage.getItem('ew_scorecard_score')||'0');
  if(score>0){
    document.getElementById('scoreText').textContent=score;
    const offset=264-(264*score/100);
    document.getElementById('scoreCircle').style.strokeDashoffset=offset;
    document.getElementById('scorecardStatus').textContent=score>=71?'Strong heir readiness':score>=41?'Needs attention':'Critical gaps identified';
  }
  // Pro gates
  if(d.user.tier!=='pro'){
    document.getElementById('scorecardGate').style.display='block';
    document.getElementById('scorecardPro').style.display='none';
    document.getElementById('qaGate').style.display='block';
    document.getElementById('qaPro').style.display='none';
  }
  // Populate settings
  document.getElementById('settingName').value=d.user.name||'';
  document.getElementById('settingEmail').value=d.user.email||'';
  document.getElementById('settingBtc').value=d.user.btcAmount||'';
  document.getElementById('settingOther').value=d.user.otherAssets||'';
  document.getElementById('settingState').value=d.user.state||'';
  document.getElementById('settingThreshold').value=d.user.alertThresholdPct||10;
}

async function saveSettings(){
  const body={
    name:document.getElementById('settingName').value,
    btcAmount:parseFloat(document.getElementById('settingBtc').value)||0,
    otherAssets:parseFloat(document.getElementById('settingOther').value)||0,
    state:document.getElementById('settingState').value,
    alertThresholdPct:parseInt(document.getElementById('settingThreshold').value)||10,
  };
  await fetch('/api/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body),credentials:'include'});
  const s=document.getElementById('saveStatus');
  s.style.display='inline';
  setTimeout(()=>{s.style.display='none';},2000);
}

async function sendQuestion(){
  const input=document.getElementById('qaInput');
  const q=input.value.trim();
  if(!q)return;
  input.value='';
  const histEl=document.getElementById('qaHistory');
  histEl.innerHTML+=`<div class="qa-msg user">${q}</div>`;
  document.getElementById('qaSend').disabled=true;
  const thinkingDiv=document.createElement('div');
  thinkingDiv.className='qa-msg assistant';
  thinkingDiv.textContent='Thinking…';
  histEl.appendChild(thinkingDiv);
  histEl.scrollTop=histEl.scrollHeight;
  try{
    const r=await fetch('/api/qa',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:q,conversationHistory:qaHistory}),credentials:'include'});
    const d=await r.json();
    thinkingDiv.textContent=d.answer||d.error||'No response.';
    qaHistory.push({role:'user',content:q},{role:'assistant',content:d.answer||''});
    if(qaHistory.length>8)qaHistory=qaHistory.slice(-8);
  }catch(ex){thinkingDiv.textContent='Error: '+ex.message;}
  document.getElementById('qaSend').disabled=false;
  histEl.scrollTop=histEl.scrollHeight;
}
document.getElementById('qaInput')?.addEventListener('keydown',function(e){if(e.key==='Enter')sendQuestion();});
document.getElementById('signOutBtn').addEventListener('click',function(e){e.preventDefault();document.cookie='ew_session=;Max-Age=0;Path=/monitor';window.location.href='/monitor/login';});

loadDashboard();
setInterval(loadDashboard,1800000); // refresh every 30 min
</script>
<script defer data-cf-beacon='{"token":"3c8ee81a6842447bb64ffc1b8fb36b19"}' src="https://static.cloudflareinsights.com/beacon.min.js"></script>
</body>
</html>
